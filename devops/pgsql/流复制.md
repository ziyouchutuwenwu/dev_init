# 流复制

比以前的版本简单的很多

参考 [这里](https://blog.yasking.org/a/postgresql-12-streaming-replication.html) 和 [这里](https://blog.japinli.top/2020/02/postgresql-stream-replication/)

## 步骤

### master 修改

创建用于复制的帐号

```sh
sudo -u postgres psql
create user replicator replication encrypted password '123456';
```

允许 slave 连, master 上配置

```sh
sudo su - postgres
```

md5 模式的话，在 slave 上执行 pg_basebackup 需要输入 replicator 的密码，trust 则不需要

/etc/postgresql/13/main/pg_hba.conf

```sh
host replication replicator 0.0.0.0/0 md5"
```

重载配置

```sh
sudo -u postgres psql
select pg_reload_conf();
```

### slave 参数

#### 配置主从切换的触发文件

/etc/postgresql/13/main/postgresql.conf

```sh
promote_trigger_file = '/tmp/switch_to_master'
```

查看

```sh
sudo su - postgres
psql
show promote_trigger_file;
```

#### 做基础备份

删除 slave 数据目录下的所有文件，其目的是为同步 master 做准备，否则同步数据时会发现 master 与 slave 的校验不一致导致同步数据失败

```sh
sudo su - postgres
psql
show data_directory;

rm -rf /var/lib/postgresql/13/main
```

复制基础备份，88.100 为 master ip

```sh
pg_basebackup -h 192.168.88.100 -U replicator -p 5432 -D /var/lib/postgresql/13/main -Fp -Xs -P -R
```

使用 pg_basebackup 工具来同步基础数据，参数 -R 会在数据目录下新建 standby.signal 文件，这个文件表示本数据库作为备份库存在，其只能读取，无法更新和写入；
同样，设置了 -R 参数后，同步工具会自动添加配置信息，配置文件及内容如下

```sh
cat postgresql.auto.conf
# Do not edit this file manually!
# It will be overwritten by the ALTER SYSTEM command.
primary_conninfo = 'user=replicator passfile=''/var/lib/postgresql/.pgpass'' channel_binding=prefer host=192.168.88.100 port=5432 sslmode=prefer sslcompression=0 ssl_min_protocol_version=TLSv1.2 gssencmode=prefer krbsrvname=postgres target_session_attrs=any'
```

### master

在 master 下检验部署

```sh
sudo -u postgres psql
select * from pg_stat_replication;
```

应该能看到一系列输出

### 测试

在 master 和 slave 上分别做以下测试

```sh
sudo -u postgres psql
select pg_is_in_recovery();
```

正常情况下，master 可以 insert，slave 无法 insert

#### slave 提升为 master

模拟 master 挂掉， slave 机器做如下操作，自动切换为 master

```sh
touch /tmp/switch_to_master
```

或者，后面的为等待时间

```sh
select pg_promote(true, 60);
```

可以正常 insert，重新查看一下状态

```sh
select pg_is_in_recovery();
```

### 同步/异步状态修改

使用 sync 模式同步的时候，slave 至少有一个需要存活，不然 master 上所有需要写数据的操作都无法进行

#### 查询热备方式

在 master 上查询当前同步模式

```sh
\x
select * from pg_stat_replication;
```

查看 sync_state, 发现默认是异步

#### 改成同步模式

master，不要改 postgresql.conf 这个配置文件，测试没有效果

以下配置永久生效, synchronous_standby_names 支持多个, 逗号隔开

```sh
alter system set synchronous_standby_names to 'aaa,bbb';
select pg_reload_conf();
```

slave

```sh
/var/lib/postgresql/13/main/postgresql.auto.conf
```

```sh
修改 primary_conninfo
最后添加 application_name=bbb
```
