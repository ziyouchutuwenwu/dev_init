# 例子

## 说明

建议作为 nginx 的辅助，做一些前置的工作

## 步骤

### 目录结构

```sh
├── lua
│   ├── debug.lua
│   ├── filter
│   │   ├── post
│   │   │   └── add_header.lua
│   │   ├── post.lua
│   │   ├── pre
│   │   │   ├── block_ip.lua
│   │   │   └── ssl.lua
│   │   └── pre.lua
│   └── path.lua
├── nginx.conf
└── ssl
    ├── cert.crt
    └── key.key
```

### lua 配置

nginx.conf

```conf
worker_processes 1;

events {
    worker_connections 1024;
}

http {
    error_log /dev/stderr warn;
    access_log /dev/stdout;

    init_by_lua_block {
        dofile("/usr/local/openresty/nginx/lua/path.lua")
    }

    server {
        listen 80;
        server_name _;

        access_by_lua_file /usr/local/openresty/nginx/lua/filter/pre.lua;
        header_filter_by_lua_file /usr/local/openresty/nginx/lua/filter/post.lua;
        body_filter_by_lua_file /usr/local/openresty/nginx/lua/filter/post.lua;

        location / {
            content_by_lua_file /usr/local/openresty/nginx/lua/debug.lua;
        }
    }

    server {
        listen 443 ssl;
        server_name .xxx.com;

        ssl_certificate     /usr/local/openresty/nginx/ssl/cert.crt;
        ssl_certificate_key /usr/local/openresty/nginx/ssl/key.key;

        access_by_lua_file /usr/local/openresty/nginx/lua/filter/pre.lua;
        header_filter_by_lua_file /usr/local/openresty/nginx/lua/filter/post.lua;
        body_filter_by_lua_file /usr/local/openresty/nginx/lua/filter/post.lua;

        location / {
            content_by_lua_file /usr/local/openresty/nginx/lua/debug.lua;
        }
    }
}
```

path.lua

```lua
local current_dir = debug.getinfo(1, "S").source:sub(2):match("(.*/)")
local lua_root = current_dir .. ""

-- 配置全局 package.path
package.path = table.concat({
    lua_root .. "?.lua",
    lua_root .. "utils/?.lua",
    lua_root .. "filter/pre/?.lua",
    lua_root .. "filter/post/?.lua",
    package.path
}, ";")

-- 导出 root
return {
    root = lua_root
}
```

pre.lua

```lua
local path = require("path")

local pre_files = {
    "block_ip.lua",
    "ssl.lua",
}

local pre_dir = path.root .. "filter/pre/"

for _, filename in ipairs(pre_files) do
    local mod = dofile(pre_dir .. filename)
    mod.check()
end
```

post.lua

```lua
local path = require("path")

local post_files = {
    "add_header.lua",
}

local post_dir = path.root .. "filter/post/"
local phase = ngx.get_phase()

for _, filename in ipairs(post_files) do
    local mod = dofile(post_dir .. filename)
    if phase == "header_filter" and mod.header then
        mod.header()
    elseif phase == "body_filter" and mod.body then
        mod.body()
    end
end
```

block_ip.lua

```lua
local M = {}

local ipmatcher = require "resty.ipmatcher"

local black_list = {
    "111.111.111.111",
    "192.168.1.0/24",
}

local matcher = ipmatcher.new(black_list)

function M.check()
    local ip = ngx.var.remote_addr
    ngx.log(ngx.WARN, "ip : ", ip)
    if matcher:match(ip) then
        ngx.log(ngx.WARN, "ip blocked: ", ip)
        return ngx.exit(444)
    end
end

return M
```

ssl.lua

```lua
local M = {}

local ipmatcher = require "resty.ipmatcher"

local white_list = {
    "192.168.1.0/24",
    "10.0.0.0/8",
}

local matcher = ipmatcher.new(white_list)

function M.check()
    local ip = ngx.var.remote_addr
    ngx.log(ngx.WARN, "in ssl ", ip)

    -- 不允许的 ip，直接跳转 https
    if not matcher:match(ip) then
        if ngx.var.scheme == "http" then
            local url = string.format("https://%s%s", ngx.var.host, ngx.var.request_uri)
            ngx.log(ngx.WARN, "http, will jump to ", url)
            return ngx.redirect(url, 301)
        end
    else
        ngx.log(ngx.WARN, "in ssl whitelist ", ip)
    end
end

return M
```

add_header.lua

```lua
local M = {}

function M.header()
    ngx.header["xxx"] = "1.0.0"
end

return M
```

debug.lua

```lua
local path = require("path")

local uri = ngx.var.uri

if uri == "/" then
    ngx.say("home")
elseif uri == "/aaa" then
    ngx.say("/aaa")
elseif uri == "/bbb" then
    ngx.say("/bbb")
else
    ngx.status = 404
    ngx.say("not found")
end
```

### 启动

```sh
docker run --rm --network=host -it \
  -v $(pwd)/nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf:ro \
  -v $(pwd)/lua:/usr/local/openresty/nginx/lua:ro \
  -v $(pwd)/ssl:/usr/local/openresty/nginx/ssl:ro \
  openresty/openresty:alpine sh


sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories
apk add --no-cache curl perl fd ripgrep
opm get xiangnanscu/lua-resty-ipmatcher
```

### 测试

```sh
curl http://10.0.2.1
curl https://10.0.2.1 -k
```
