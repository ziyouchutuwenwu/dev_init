# 节点监控

## 说明

要么手动查看 `ets:tab2list(sys_dist).`

要么设置回调函数

```erlang
net_kernel:monitor_nodes(true, [{node_type, visible}])
net_kernel:monitor_nodes(true, [{node_type, hidden}])
net_kernel:monitor_nodes(true, [{node_type, all}])

% 对应的回调里面的消息
{nodeup, Node, [{node_type, visible}]}
{nodedown, Node, [{node_type, visible}]}

{nodeup, Node, [{node_type, hidden}]}
{nodedown, Node, [{node_type, hidden}]}

{nodeup, Node, [{node_type, all}]}
{nodedown, Node, [{node_type, all}]}
```

## 例子

```erlang
-module(node_monitor).

-export([start_link/0, init/1, loop_receive/1]).

start_link() ->
    Monitored = ['aaa@127.0.0.1', 'bbb@127.0.0.1'],
    spawn_link(?MODULE, init, [Monitored]).

init(Monitored) ->
    net_kernel:monitor_nodes(true, [{node_type, all}]),
    io:format("[~p] 节点监控启动, 监听节点: ~p~n", [node(), Monitored]),
    loop_receive(Monitored).

loop_receive(Monitored) ->
    receive
        Msg ->
            case Msg of
                {nodeup, Node, Info} ->
                    case lists:member(Node, Monitored) of
                        true ->
                            io:format("[~p] 节点上线: ~p, Info: ~p~n", [node(), Node, Info]);
                        false ->
                            ok
                    end;
                {nodedown, Node, Info} ->
                    case lists:member(Node, Monitored) of
                        true ->
                            io:format("[~p] 节点下线: ~p, Info: ~p~n", [node(), Node, Info]);
                        false ->
                            ok
                    end;
                Other ->
                    io:format("[~p] 其他消息: ~p~n", [node(), Other])
            end,
            loop_receive(Monitored)
    end.
```

测试

```sh
rebar3 shell --name demo@127.0.0.1 --setcookie 123456
```

```sh
erl -name aaa@127.0.0.1 -setcookie 123456
net_kernel:connect_node('demo@127.0.0.1').
```

列出全部节点

```erlang
nodes(connected).
nodes(hidden).
```

## 注意

```erlang
% 旧的调用方式，不推荐
net_kernel:monitor_nodes(true)
{nodeup, Node}
{nodedown, Node}
```

等同于

```erlang
net_kernel:monitor_nodes(true, [{node_type, visible}])
{nodeup, Node, [{node_type, visible}]}
{nodedown, Node, [{node_type, visible}]}
```
